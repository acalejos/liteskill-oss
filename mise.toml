[tools]
elixir = "1.18"
erlang = "28"
node = "24"
mdbook = "latest"
zig = "0.15.2"

[tasks.singleuser]
description = "Start Phoenix dev server in single-user mode"
run = "SINGLE_USER_MODE=true mix phx.server"

[tasks.local-tauri]
description = "Open a Tauri dev window pointed at localhost:4000 (no sidecar)"
dir = "src-tauri"
run = "LITESKILL_DEV=true cargo tauri dev"

[tasks.linux-appimage]
description = "Build Linux x86_64 AppImage via Docker (full CI-equivalent build)"
run = """
#!/usr/bin/env bash
set -euo pipefail

IMAGE="liteskill-desktop-build"
OUT_DIR="dist/linux"

echo "==> Building desktop Linux toolchain image (cached after first run)..."
docker build -f scripts/Dockerfile.desktop-build -t "$IMAGE" .

echo "==> Running desktop build (project mounted into container)..."
docker run --rm -u "$(id -u):$(id -g)" \
    -e HOME=/tmp/build-home \
    -e CARGO_HOME=/tmp/build-home/.cargo \
    -v "$(pwd):/build" "$IMAGE" \
    bash -c 'mkdir -p /tmp/build-home && bash scripts/build-desktop.sh x86_64-unknown-linux-gnu'

echo "==> Collecting build artifacts..."
rm -rf "$OUT_DIR"
mkdir -p "$OUT_DIR"

cp src-tauri/target/release/bundle/appimage/*.AppImage "$OUT_DIR/" 2>/dev/null || true

# Clear stale Burrito ERTS cache so the new sidecar binary extracts fresh.
# Burrito caches by app version â€” if the version hasn't changed between builds,
# it reuses the old extraction and ignores code changes.
rm -rf "$HOME/.local/share/.burrito/desktop_"*

echo ""
echo "==> Build artifacts in $OUT_DIR:"
ls -lh "$OUT_DIR"
"""

